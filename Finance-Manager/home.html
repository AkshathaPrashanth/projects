<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finance Manager - Expense Tracker</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Finance Manager">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

/* Navigation Bar */
.navbar {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding: 1rem 2rem;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
}

.nav-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
}

.logo {
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
    text-decoration: none;
}

.nav-links {
    display: flex;
    list-style: none;
    gap: 2rem;
}

.nav-links a {
    color: white;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.nav-links a:hover,
.nav-links a.active {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

.mobile-menu-btn {
    display: none;
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

/* Main Content */
.main-content {
    margin-top: 70px;
    margin-bottom: 80px;
    padding: 2rem;
}

/*.bg-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
*/

.bg-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background: url('images.jpg') no-repeat center center fixed;
    background-size: cover;
}


/* Note Area */
.note-area {
    max-width: 600px;
    margin: 0 auto 2rem;
    background: rgba(127, 213, 163, 0.95);
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.note-container {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 1rem;
}

.note-ui {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.note-dropdown {
    background: #667eea;
    color: #8dcea3;
    border: none;
    padding: 0.75rem;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
}

.note-dropdown:hover {
    background: #5a67d8;
    transform: translateY(-2px);
}

.description-input {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.description-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Category Buttons */
.buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.buttonsSC {
    display: none;
}

.buttons button {
    background: rgba(255, 255, 255, 0.9);
    border: none;
    padding: 1rem 1.5rem;
    border-radius: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    color: #333;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.buttons button:hover {
    background: white;
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.buttons button.active {
    background: #667eea;
    color: white;
}

.buttonsSC button {
    background: rgba(255, 255, 255, 0.9);
    border: none;
    padding: 1rem;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: #333;
}

.buttonsSC button:hover {
    background: white;
    transform: translateY(-3px);
}

.buttonsSC button.active {
    background: #667eea;
    color: white;
}

/* Input Container */
.input-container {
    display: flex;
    gap: 1rem;
    max-width: 600px;
    margin: 0 auto 2rem;
    background: rgba(255, 255, 255, 0.95);
    padding: 1.5rem;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.plus-button {
    background: #48bb78;
    color: white;
    border: none;
    padding: 1rem;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.plus-button:hover {
    background: #38a169;
    transform: scale(1.1);
}

.amount-input {
    width: 120px;
    padding: 0.75rem;
    border: 2px solid rgba(224, 227, 225, 0.95);
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
}

.amount-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Items Container */
.items-container {
    max-width: 800px;
    margin: 0 auto;
    background: rgba(127, 213, 163, 0.95);
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    min-height: 200px;
}

.expense-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    margin-bottom: 0.5rem;
    background: #ffffff;
    border-radius: 10px;
    border-left: 4px solid #667eea;
}

.expense-item .description {
    font-weight: 600;
    color: #333;
}

.expense-item .amount {
    font-weight: 700;
    color: #e53e3e;
}

.expense-item .category {
    background: #667eea;
    color: #ffffff;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.delete-btn {
    background: #e53e3e;
    color: white;
    border: none;
    padding: 0.5rem;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.delete-btn:hover {
    background: #c53030;
    transform: scale(1.1);
}

/* Summary */
.summary {
    text-align: center;
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 10px;
}

.summary h3 {
    color: #667eea;
    margin-bottom: 0.5rem;
}

.summary .total-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: #e53e3e;
}

/* Notification */
.notification {
    position: fixed;
    top: 100px;
    right: 20px;
    background: #48bb78;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transform: translateX(400px);
    transition: all 0.3s ease;
    z-index: 1001;
}

.notification.show {
    transform: translateX(0);
}

/* Bottom Navigation */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(25, 107, 70, 0.755);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    padding: 1rem;
    z-index: 1000;
}

.nav-container-bottom {
    display: flex;
    justify-content: space-around;
    max-width: 400px;
    margin: 0 auto;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: #666;
    transition: all 0.3s ease;
    padding: 0.5rem;
    border-radius: 10px;
    min-width: 80px;
}

.nav-item:hover,
.nav-item.active {
    color: #667eea;
    background: rgba(102, 126, 234, 0.1);
    transform: translateY(-2px);
}

.nav-item i {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
}

.nav-item span {
    font-size: 0.8rem;
    font-weight: 600;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .nav-links {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        flex-direction: column;
        padding: 1rem;
        gap: 0;
    }

    .nav-links.active {
        display: flex;
    }

    .mobile-menu-btn {
        display: block;
    }

    .main-content {
        padding: 1rem;
    }

    .buttons {
        display: none;
    }

    .buttonsSC {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .input-container {
        flex-direction: column;
        gap: 1rem;
    }

    .amount-input {
        width: 100%;
    }

    .expense-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .expense-item .amount {
        align-self: flex-end;
    }
}
</style>
</head>
<body>
  <script src="app.js"></script>
 
<!-- Top Header -->
<div style="background: rgba(25, 107, 70, 0.755); backdrop-filter: blur(10px); padding: 1rem; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000;">
    <h1 style="color: rgb(255, 255, 255); margin: 0; font-size: 1.5rem; font-weight: bold;">
        <i class="fa-solid fa-list"></i> Expense Tracker
    </h1>
</div>

<div class="bg-container"></div>

<main class="main-content">
    <!-- Note Area -->
    <div class="note-area">
        <div class="note-container" id="noteContainer">
            <p style="text-align: center; color: #666; font-style: italic;">No notes yet. Add your first note below!</p>
        </div>
        <div class="note-ui">
            <select class="note-dropdown" id="noteDropdown">
                <option value="general">📝 General</option>
                <option value="reminder">⏰ Reminder</option>
                <option value="goal">🎯 Goal</option>
                <option value="tip">💡 Tip</option>
            </select>
            <input type="text" class="description-input" id="noteInput" placeholder="Add a note...">
            <button class="plus-button" onclick="addNote()">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- Category Buttons (Desktop) -->
    <div class="buttons">
        <button onclick="setCategory('food')" id="foodBtn">
            <i class="fa-solid fa-utensils"></i> Food
        </button>
        <button onclick="setCategory('transport')" id="transportBtn">
            <i class="fa-solid fa-car"></i> Transport
        </button>
        <button onclick="setCategory('entertainment')" id="entertainmentBtn">
            <i class="fa-solid fa-gamepad"></i> Entertainment
        </button>
        <button onclick="setCategory('shopping')" id="shoppingBtn">
            <i class="fa-solid fa-shopping-bag"></i> Shopping
        </button>
        <button onclick="setCategory('bills')" id="billsBtn">
            <i class="fa-solid fa-file-invoice"></i> Bills
        </button>
        <button onclick="setCategory('other')" id="otherBtn">
            <i class="fa-solid fa-ellipsis"></i> Other
        </button>
    </div>

    <!-- Category Buttons (Mobile) -->
    <div class="buttonsSC">
        <button onclick="setCategory('food')" id="foodBtnSC" title="Food">
            <i class="fa-solid fa-utensils"></i>
        </button>
        <button onclick="setCategory('transport')" id="transportBtnSC" title="Transport">
            <i class="fa-solid fa-car"></i>
        </button>
        <button onclick="setCategory('entertainment')" id="entertainmentBtnSC" title="Entertainment">
            <i class="fa-solid fa-gamepad"></i>
        </button>
        <button onclick="setCategory('shopping')" id="shoppingBtnSC" title="Shopping">
            <i class="fa-solid fa-shopping-bag"></i>
        </button>
        <button onclick="setCategory('bills')" id="billsBtnSC" title="Bills">
            <i class="fa-solid fa-file-invoice"></i>
        </button>
        <button onclick="setCategory('other')" id="otherBtnSC" title="Other">
            <i class="fa-solid fa-ellipsis"></i>
        </button>
    </div>

    <!-- Input Container -->
    <div class="input-container">
        <input type="number" class="amount-input" id="amountInput" placeholder="Amount ₹" step="0.01">
        <input type="text" class="description-input" id="descriptionInput" placeholder="Description...">
        <button class="plus-button" onclick="addExpense()">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <!-- Items Container -->
    <div class="items-container">
        <div id="expensesList">
            <p style="text-align: center; color: #666; font-style: italic; margin-top: 2rem;">
                No expenses added yet. Add your first expense above!
            </p>
        </div>
        <div class="summary" id="summary" style="display: none;">
            <h3>Total Expenses</h3>
            <div class="total-amount" id="totalAmount">₹ 0</div>
        </div>
    </div>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <div class="nav-container-bottom">
        <a href="splitter.html" class="nav-item active">
            <i class="fa-solid fa-list"></i>
            <span>Tracker</span>
        </a>
        <a href="splitter.html" onclick="navigateToBudget()" class="nav-item">
            <i class="fa-solid fa-chart-pie"></i>
            <span>Budget</span>
        </a>
    </div>
</nav>

<!-- Notification -->
<div class="notification" id="notification">
    <span id="notificationText">Expense added successfully!</span>
</div>
<script>
// Global variables - Initialize immediately
let selectedCategory = 'food';
let expenses = [];
let notes = [];

// Category-based localStorage management
class CategoryDataManager {
  constructor() {
    this.categories = ['food', 'transport', 'entertainment', 'shopping', 'bills', 'other'];
    this.initializeCategories();
  }

  initializeCategories() {
    this.categories.forEach(category => {
      if (!localStorage.getItem(category)) {
        localStorage.setItem(category, JSON.stringify([]));
      }
    });
    localStorage.setItem('expense_categories', JSON.stringify(this.categories));
  }

  saveExpenseToCategory(expense) {
    const category = this.mapCategoryName(expense.category) || 'other';
    const categoryExpenses = this.getExpensesByCategory(category);
    
    const expenseData = {
      id: expense.id || Date.now(),
      amount: expense.amount,
      description: expense.description,
      date: expense.date || new Date().toLocaleDateString(),
      timestamp: Date.now()
    };
    
    categoryExpenses.push(expenseData);
    localStorage.setItem(category, JSON.stringify(categoryExpenses));
    console.log(`Expense saved to ${category}:`, expenseData);
    return expenseData;
  }

  getExpensesByCategory(category) {
    try {
      const data = localStorage.getItem(category);
      return data ? JSON.parse(data) : [];
    } catch (error) {
      console.error(`Error loading category ${category}:`, error);
      return [];
    }
  }

  getAllExpenses() {
    const allExpenses = {};
    this.categories.forEach(category => {
      allExpenses[category] = this.getExpensesByCategory(category);
    });
    return allExpenses;
  }

  getAllExpensesFlattened() {
    const allExpenses = [];
    this.categories.forEach(category => {
      const categoryExpenses = this.getExpensesByCategory(category);
      categoryExpenses.forEach(expense => {
        allExpenses.push({
          ...expense,
          category: category
        });
      });
    });
    return allExpenses.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
  }

  deleteExpenseFromCategory(expenseId) {
    let deletedFrom = null;
    
    this.categories.forEach(category => {
      const categoryExpenses = this.getExpensesByCategory(category);
      const filteredExpenses = categoryExpenses.filter(expense => expense.id !== expenseId);
      
      if (filteredExpenses.length !== categoryExpenses.length) {
        localStorage.setItem(category, JSON.stringify(filteredExpenses));
        deletedFrom = category;
      }
    });
    
    return deletedFrom;
  }

  getCategoryStats() {
    const stats = {};
    this.categories.forEach(category => {
      const expenses = this.getExpensesByCategory(category);
      const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
      stats[category] = {
        count: expenses.length,
        total: total,
        average: expenses.length > 0 ? total / expenses.length : 0
      };
    });
    return stats;
  }

  mapCategoryName(appCategory) {
    const categoryMap = {
      'food': 'food',
      'delivery': 'food',
      'dining': 'food',
      'restaurant': 'food',
      'transport': 'transport',
      'transportation': 'transport',
      'travel': 'transport',
      'uber': 'transport',
      'taxi': 'transport',
      'entertainment': 'entertainment',
      'fun': 'entertainment',
      'movies': 'entertainment',
      'games': 'entertainment',
      'shopping': 'shopping',
      'shop': 'shopping',
      'store': 'shopping',
      'clothes': 'shopping',
      'bills': 'bills',
      'utilities': 'bills',
      'rent': 'bills',
      'insurance': 'bills',
      'other': 'other',
      'miscellaneous': 'other',
      'misc': 'other'
    };
    return categoryMap[appCategory?.toLowerCase()] || 'other';
  }

  exportAllData() {
    const allData = this.getAllExpenses();
    const exportData = {
      categories: allData,
      metadata: {
        exportDate: new Date().toISOString(),
        totalCategories: this.categories.length,
        version: '2.0.0'
      }
    };
    return exportData;
  }

  importData(importedData) {
    if (importedData.categories) {
      Object.keys(importedData.categories).forEach(category => {
        if (this.categories.includes(category)) {
          const existingExpenses = this.getExpensesByCategory(category);
          const newExpenses = importedData.categories[category];
          const mergedExpenses = [...existingExpenses, ...newExpenses];
          localStorage.setItem(category, JSON.stringify(mergedExpenses));
        }
      });
    } else if (importedData.expenses) {
      importedData.expenses.forEach(expense => {
        this.saveExpenseToCategory(expense);
      });
    }
  }

  clearAllData() {
    this.categories.forEach(category => {
      localStorage.setItem(category, JSON.stringify([]));
    });
  }
}

// Initialize category data manager immediately
const categoryDataManager = new CategoryDataManager();
window.categoryDataManager = categoryDataManager;

// Core App Functions
function initializeAppData() {
  console.log('🔄 Initializing app data...');
  
  try {
    // Load expenses from category-based localStorage
    expenses = categoryDataManager.getAllExpensesFlattened() || [];
    window.expenses = expenses; // Make globally accessible
    console.log(`✅ Loaded ${expenses.length} expenses from localStorage`);

    // Load notes from localStorage
    const notesRaw = localStorage.getItem('financeManagerNotes');
    if (notesRaw) {
      try {
        const notesData = JSON.parse(notesRaw);
        notes = notesData.notes || [];
        window.notes = notes; // Make globally accessible
        console.log(`✅ Loaded ${notes.length} notes from localStorage`);
      } catch (e) {
        console.error('❌ Error parsing notes:', e);
        notes = [];
        window.notes = [];
      }
    } else {
      notes = [];
      window.notes = [];
    }

    // Load selected category from localStorage
    const savedCategory = localStorage.getItem('selectedCategory');
    if (savedCategory && ['food', 'transport', 'entertainment', 'shopping', 'bills', 'other'].includes(savedCategory)) {
      selectedCategory = savedCategory;
    } else {
      selectedCategory = 'food';
    }
    window.selectedCategory = selectedCategory;

    // Update all UI components
    updateAllUI();

    console.log('✅ App data initialization complete');
    return true;

  } catch (error) {
    console.error('❌ Error initializing app data:', error);
    // Initialize with empty data on error
    expenses = [];
    notes = [];
    selectedCategory = 'food';
    window.expenses = expenses;
    window.notes = notes;
    window.selectedCategory = selectedCategory;
    return false;
  }
}

// UI Update Functions
function updateAllUI() {
  updateExpensesList();
  updateNotesList();
  updateSummary();
  updateCategoryButtons();
  console.log('🎨 UI updated with loaded data');
}

function updateCategoryButtons() {
  try {
    // Update desktop buttons
    const desktopButtons = document.querySelectorAll('.buttons button');
    if (desktopButtons.length > 0) {
      desktopButtons.forEach(btn => btn.classList.remove('active'));
      const activeBtn = document.getElementById(selectedCategory + 'Btn');
      if (activeBtn) activeBtn.classList.add('active');
    }
    
    // Update mobile buttons
    const mobileButtons = document.querySelectorAll('.buttonsSC button');
    if (mobileButtons.length > 0) {
      mobileButtons.forEach(btn => btn.classList.remove('active'));
      const activeBtnSC = document.getElementById(selectedCategory + 'BtnSC');
      if (activeBtnSC) activeBtnSC.classList.add('active');
    }
  } catch (error) {
    console.error('Error updating category buttons:', error);
  }
}

function updateExpensesList() {
  const expensesList = document.getElementById('expensesList');
  
  if (!expensesList) {
    console.error('Expenses list element not found');
    return;
  }
  
  if (!expenses || expenses.length === 0) {
    expensesList.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; margin-top: 2rem;">No expenses added yet. Add your first expense above!</p>';
    return;
  }
  
  // Sort expenses by timestamp (newest first)
  const sortedExpenses = [...expenses].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
  
  expensesList.innerHTML = sortedExpenses.map(expense => {
    // Escape HTML to prevent XSS
    const safeDescription = escapeHtml(expense.description);
    const safeAmount = expense.amount.toLocaleString('en-IN');
    
    return `
      <div class="expense-item">
        <div>
          <div class="description">${safeDescription}</div>
          <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">${expense.date}</div>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <span class="category">${getCategoryIcon(expense.category)} ${expense.category}</span>
          <span class="amount">₹ ${safeAmount}</span>
          <button class="delete-btn" onclick="deleteExpense(${expense.id})" title="Delete expense">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function updateNotesList() {
  const noteContainer = document.getElementById('noteContainer');
  
  if (!noteContainer) {
    console.error('Note container element not found');
    return;
  }
  
  if (!notes || notes.length === 0) {
    noteContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No notes yet. Add your first note below!</p>';
    return;
  }
  
  // Sort notes by timestamp (newest first)
  const sortedNotes = [...notes].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
  
  noteContainer.innerHTML = sortedNotes.map(note => {
    const safeText = escapeHtml(note.text);
    
    return `
      <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: #f8fafc; border-radius: 8px; border-left: 3px solid #667eea;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #333;">${getNoteIcon(note.type)} ${safeText}</div>
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">${note.date}</div>
          </div>
          <button onclick="deleteNote(${note.id})" title="Delete note" style="background: #e53e3e; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function updateSummary() {
  const summary = document.getElementById('summary');
  const totalAmount = document.getElementById('totalAmount');
  
  if (!summary || !totalAmount) {
    console.error('Summary elements not found');
    return;
  }
  
  if (!expenses || expenses.length === 0) {
    summary.style.display = 'none';
    return;
  }
  
  const total = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
  totalAmount.textContent = `₹ ${total.toLocaleString('en-IN')}`;
  summary.style.display = 'block';
}

// Core Action Functions
function setCategory(category) {
  selectedCategory = category;
  window.selectedCategory = selectedCategory;
  
  // Save selected category
  localStorage.setItem('selectedCategory', category);
  
  // Update button states
  updateCategoryButtons();
}

function addExpense() {
  const amountInput = document.getElementById('amountInput');
  const descriptionInput = document.getElementById('descriptionInput');
  
  if (!amountInput || !descriptionInput) {
    console.error('Input elements not found');
    showNotification('Form elements not found!', 'error');
    return;
  }
  
  const amount = parseFloat(amountInput.value);
  const description = descriptionInput.value.trim();
  
  if (!amount || amount <= 0) {
    showNotification('Please enter a valid amount!', 'error');
    amountInput.focus();
    return;
  }
  
  if (!description) {
    showNotification('Please enter a description!', 'error');
    descriptionInput.focus();
    return;
  }
  
  const expense = {
    id: Date.now() + Math.random(), // Ensure unique ID
    amount: amount,
    description: description,
    category: selectedCategory,
    date: new Date().toLocaleDateString(),
    timestamp: Date.now()
  };
  
  try {
    // Save to category-based storage
    categoryDataManager.saveExpenseToCategory(expense);
    
    // Update local data
    expenses = categoryDataManager.getAllExpensesFlattened();
    window.expenses = expenses;
    
    // Update UI
    updateExpensesList();
    updateSummary();
    
    // Clear inputs
    amountInput.value = '';
    descriptionInput.value = '';
    
    showNotification('Expense added successfully!', 'success');
    
    // Focus back to amount input for quick entry
    setTimeout(() => amountInput.focus(), 100);
    
  } catch (error) {
    console.error('Error adding expense:', error);
    showNotification('Error adding expense!', 'error');
  }
}

function addNote() {
  const noteInput = document.getElementById('noteInput');
  const noteDropdown = document.getElementById('noteDropdown');
  
  if (!noteInput || !noteDropdown) {
    console.error('Note input elements not found');
    showNotification('Note form elements not found!', 'error');
    return;
  }
  
  const noteText = noteInput.value.trim();
  const noteType = noteDropdown.value;
  
  if (!noteText) {
    showNotification('Please enter a note!', 'error');
    noteInput.focus();
    return;
  }
  
  const note = {
    id: Date.now() + Math.random(), // Ensure unique ID
    text: noteText,
    type: noteType,
    date: new Date().toLocaleDateString(),
    timestamp: Date.now()
  };
  
  try {
    // Add to notes array and save immediately
    notes.push(note);
    window.notes = notes;
    
    const notesData = {
      notes: notes,
      timestamp: Date.now(),
      version: '2.0.0'
    };
    localStorage.setItem('financeManagerNotes', JSON.stringify(notesData));
    
    // Update UI
    updateNotesList();
    
    // Clear input
    noteInput.value = '';
    noteDropdown.value = 'general'; // Reset to default
    
    showNotification('Note added successfully!', 'success');
    
    // Focus back to input for quick entry
    setTimeout(() => noteInput.focus(), 100);
    
  } catch (error) {
    console.error('Error adding note:', error);
    showNotification('Error adding note!', 'error');
  }
}

function deleteExpense(id) {
  if (!confirm('Are you sure you want to delete this expense?')) {
    return;
  }
  
  try {
    const deletedFrom = categoryDataManager.deleteExpenseFromCategory(id);
    if (deletedFrom) {
      // Update local data
      expenses = categoryDataManager.getAllExpensesFlattened();
      window.expenses = expenses;
      
      // Update UI
      updateExpensesList();
      updateSummary();
      
      showNotification(`Expense deleted from ${deletedFrom}!`, 'success');
    } else {
      showNotification('Expense not found!', 'error');
    }
  } catch (error) {
    console.error('Error deleting expense:', error);
    showNotification('Error deleting expense!', 'error');
  }
}

function deleteNote(id) {
  if (!confirm('Are you sure you want to delete this note?')) {
    return;
  }
  
  try {
    notes = notes.filter(note => note.id !== id);
    window.notes = notes;
    
    // Save to localStorage immediately
    const notesData = {
      notes: notes,
      timestamp: Date.now(),
      version: '2.0.0'
    };
    localStorage.setItem('financeManagerNotes', JSON.stringify(notesData));
    
    // Update UI
    updateNotesList();
    showNotification('Note deleted!', 'success');
  } catch (error) {
    console.error('Error deleting note:', error);
    showNotification('Error deleting note!', 'error');
  }
}

// Helper Functions
function getCategoryIcon(category) {
  const icons = {
    food: '🍽️',
    transport: '🚗',
    entertainment: '🎮',
    shopping: '🛍️',
    bills: '📄',
    other: '📝'
  };
  return icons[category] || '📝';
}

function getNoteIcon(type) {
  const icons = {
    general: '📝',
    reminder: '⏰',
    goal: '🎯',
    tip: '💡'
  };
  return icons[type] || '📝';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showNotification(message, type = 'info') {
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notificationText');
  
  if (!notification || !notificationText) {
    console.error('Notification elements not found');
    alert(message); // Fallback
    return;
  }
  
  notificationText.textContent = message;
  notification.style.background = type === 'error' ? '#e53e3e' : type === 'warning' ? '#f59e0b' : '#48bb78';
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

function navigateToBudget() {
  showNotification('Budget feature coming soon!', 'info');
}

// Event Listeners and Initialization
function setupKeyboardShortcuts() {
  const amountInput = document.getElementById('amountInput');
  const descriptionInput = document.getElementById('descriptionInput');
  const noteInput = document.getElementById('noteInput');
  
  if (amountInput) {
    amountInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (descriptionInput) descriptionInput.focus();
      }
    });
  }
  
  if (descriptionInput) {
    descriptionInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addExpense();
      }
    });
  }
  
  if (noteInput) {
    noteInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addNote();
      }
    });
  }
}

function setupDataValidation() {
  let validationInterval;
  
  const validateDataConsistency = () => {
    try {
      const storedExpenses = categoryDataManager.getAllExpensesFlattened() || [];
      const currentExpenses = expenses || [];
      
      if (storedExpenses.length !== currentExpenses.length) {
        console.warn('⚠️ Expense data inconsistency detected, reloading...');
        expenses = storedExpenses;
        window.expenses = expenses;
        updateExpensesList();
        updateSummary();
        return;
      }
      
      console.log('✅ Data consistency validated');
      
    } catch (error) {
      console.error('❌ Error validating data consistency:', error);
    }
  };
  
  // Clear existing interval
  if (validationInterval) {
    clearInterval(validationInterval);
  }
  
  // Check data consistency every 30 seconds
  validationInterval = setInterval(validateDataConsistency, 30000);
  
  // Validate on window focus (when user returns to tab)
  window.addEventListener('focus', validateDataConsistency);
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 DOM loaded, initializing Finance Manager...');
  
  try {
    // Wait for DOM to be fully rendered
    setTimeout(() => {
      // Initialize app data
      const dataLoaded = initializeAppData();
      
      if (!dataLoaded) {
        console.warn('⚠️ Data initialization failed, using defaults');
        expenses = [];
        notes = [];
        selectedCategory = 'food';
        window.expenses = expenses;
        window.notes = notes;
        window.selectedCategory = selectedCategory;
        setCategory('food');
      }
      
      // Setup keyboard shortcuts
      setupKeyboardShortcuts();
      
      // Setup periodic data validation
      setupDataValidation();
      
      // Make functions globally available
      window.addExpense = addExpense;
      window.addNote = addNote;
      window.deleteExpense = deleteExpense;
      window.deleteNote = deleteNote;
      window.setCategory = setCategory;
      window.navigateToBudget = navigateToBudget;
      
      console.log('✅ Finance Manager initialized successfully');
      
      // Focus on amount input for immediate use
      const amountInput = document.getElementById('amountInput');
      if (amountInput) amountInput.focus();
      
    }, 100);
    
  } catch (error) {
    console.error('❌ Fatal error during initialization:', error);
    alert('Error initializing app. Please refresh the page.');
  }
});

// Export for debugging
window.FinanceApp = {
  categoryDataManager,
  expenses,
  notes,
  selectedCategory,
  addExpense,
  addNote,
  deleteExpense,
  deleteNote,
  setCategory,
  initializeAppData,
  updateAllUI
};
</script>

  

<!-- PWA Scripts 
<script src="app.js"></script>-->

</body>
</html>